{% extends "base.html" %}
{% block title %}My Profile{% endblock %}

{% block content %}

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}

<h2 class="mb-4">Manage Your Profile</h2>

<!-- --- PROFILE COMPLETENESS & BADGES --- -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Profile Completeness</h5>
        <div class="progress" role="progressbar" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: {{ profile_completeness_score }}%">{{ profile_completeness_score }}%</div>
        </div>
        {% if earned_badges %}
        <h6 class="mt-3">My Badges</h6>
        <div class="d-flex flex-wrap">
            {% for badge in earned_badges %}
            <div class="text-center p-2" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ badge.description }}">
                <i class="{{ badge.icon }} text-primary" style="font-size: 2.5rem;"></i>
                <p class="mb-0 small">{{ badge.name }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- --- MAIN PROFILE FORM --- -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Your Details</h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ profile_form.location.id_for_label }}" class="form-label">{{ profile_form.location.label }}</label>
                    {{ profile_form.location }}
                    <datalist id="city-suggestions">
                        <option value="New York, USA"><option value="London, UK"><option value="Tokyo, Japan"><option value="Sydney, Australia"><option value="Paris, France"><option value="Berlin, Germany"><option value="Toronto, Canada">
                    </datalist>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">{{ profile_form.availability.label }}</label>
                    <div class="d-flex flex-wrap">
                        {% for checkbox in profile_form.availability %}
                        <div class="form-check me-3">{{ checkbox }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ profile_form.skills_wanted.label }}</label>
                <div class="border p-2 rounded" style="height: 150px; overflow-y: auto;">
                    {{ profile_form.skills_wanted }}
                </div>
            </div>
            <div class="form-check mb-3">
                {{ profile_form.is_public }}
                <label class="form-check-label" for="{{ profile_form.is_public.id_for_label }}">Make my profile public</label>
            </div>
            <button type="submit" name="update_profile" class="btn btn-primary w-100">Save Profile Changes</button>
        </form>
    </div>
</div>

<!-- --- SKILLS I OFFER SECTION --- -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Skills I Offer</h5>
    </div>
    <div class="card-body">
        <ul class="list-group mb-3">
            {% for user_skill in user.profile.userskill_set.all %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ user_skill.skill.name }}
                    {% if user_skill.is_verified %}
                        <span class="badge bg-success" data-bs-toggle="tooltip" data-bs-placement="left" title="Verified Skill"><i class="bi bi-patch-check-fill"></i> Verified</span>
                    {% else %}
                        <a href="{% url 'generate_skill_quiz' user_skill.skill.id %}" class="btn btn-outline-primary btn-sm">Verify</a>
                    {% endif %}
                </li>
            {% empty %}
                <li class="list-group-item text-muted">No skills offered yet. Add one below!</li>
            {% endfor %}
        </ul>
        <hr>
        <h6>Add a New Skill to Offer</h6>
        <div>
            <form method="post" class="input-group">
                {% csrf_token %}
                {{ add_skill_form.skill }}
                <button type="submit" name="add_skill" class="btn btn-secondary">Add</button>
            </form>
        </div>
    </div>
</div>


<!-- --- AI SKILL SUGGESTER --- -->
<div class="card mt-4">
    <div class="card-header"><i class="bi bi-robot"></i> AI Skill Name Suggester</div>
    <div class="card-body">
        <p>Not sure what skills exist? Type a keyword and get ideas to add.</p>
        <div class="input-group">
            <input type="text" id="skill-suggestion-input" class="form-control" placeholder="e.g., 'drawing' or 'spreadsheets'">
            <button class="btn btn-outline-secondary" type="button" id="get-suggestions-btn">Get Suggestions</button>
        </div>
        <div id="suggestions-area" class="mt-3 p-2 border rounded" style="min-height: 50px;">
            <!-- Suggestions will appear here -->
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // AI Skill Suggester JS
    const getSuggestionsBtn = document.getElementById('get-suggestions-btn');
    if(getSuggestionsBtn) {
        getSuggestionsBtn.addEventListener('click', function() {
            const query = document.getElementById('skill-suggestion-input').value;
            const suggestionsArea = document.getElementById('suggestions-area');
            suggestionsArea.innerHTML = '<span class="text-muted">Asking the AI...</span>';

            fetch(`{% url 'suggest-skills' %}?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.suggestions && data.suggestions.length > 0) {
                        let html = '<p>Suggestions (add these skills via admin, then add them to your profile):</p>';
                        data.suggestions.forEach(skill => {
                            html += `<span class="badge bg-info-subtle border border-info-subtle text-info-emphasis rounded-pill me-1 mb-1">${skill}</span>`;
                        });
                        suggestionsArea.innerHTML = html;
                    } else {
                        suggestionsArea.innerHTML = '<span class="text-danger">No suggestions found.</span>';
                    }
                });
        });
    }
});
</script>
{% endblock %}